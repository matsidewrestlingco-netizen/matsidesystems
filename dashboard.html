<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tournament Planner + Dashboard (FloArena)</title>
  <style>
    :root{
      --grid:#d7d7d7;
      --text:#111;
      --muted:#666;
      --bg:#fafafa;
      --card:#fff;
      --input:#ffb74d;
      --inputText:#111;
      --good:#1b5e20;
      --warn:#e65100;
      --bad:#b71c1c;
    }
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .wrap{max-width:1200px; margin:0 auto; padding:18px;}
    h1{font-size:20px; margin:0 0 6px;}
    .sub{color:var(--muted); margin:0 0 16px; font-size:13px;}
    .grid{display:grid; grid-template-columns: 1.15fr 1fr; gap:16px;}
    .card{background:var(--card); border:1px solid var(--grid); border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); overflow:hidden;}
    .card h2{margin:0; padding:12px 14px; font-size:14px; background:#f3f3f3; border-bottom:1px solid var(--grid);}
    .row{display:flex; gap:10px; padding:12px 14px; align-items:end; flex-wrap:wrap;}
    .field{min-width:170px; flex:1;}
    .field.small{min-width:130px; flex:0.7;}
    .label{font-size:12px; color:var(--muted); margin:0 0 6px;}
    input, select{
      width:100%;
      box-sizing:border-box;
      padding:7px 9px;
      border:1px solid #bdbdbd;
      border-radius:10px;
      font-size:13px;
      background:#fff;
      color:var(--text);
      outline:none;
    }
    input.user, select.user{
      background:var(--input);
      color:var(--inputText);
      border-color:#d0831f;
      font-weight:700;
    }
    table{border-collapse:collapse; width:100%;}
    th,td{border:1px solid var(--grid); padding:8px 10px; font-size:13px; vertical-align:middle;}
    th{background:#f8f8f8; text-align:left; font-weight:650;}
    .right{text-align:right;}
    .kpi{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; padding:12px 14px;}
    .kpi .box{border:1px solid var(--grid); border-radius:12px; padding:10px;}
    .kpi .box .k{font-size:11px; color:var(--muted);}
    .kpi .box .v{font-size:18px; font-weight:850; margin-top:4px;}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; border:1px solid var(--grid); background:#fff;}
    .badge.good{color:var(--good); border-color:#a5d6a7; background:#e8f5e9;}
    .badge.warn{color:var(--warn); border-color:#ffcc80; background:#fff3e0;}
    .badge.bad{color:var(--bad); border-color:#ef9a9a; background:#ffebee;}
    .note{padding:10px 14px; color:var(--muted); font-size:12px; border-top:1px solid var(--grid);}
    .actions{display:flex; gap:10px; padding:12px 14px; border-top:1px solid var(--grid); background:#fff; flex-wrap:wrap;}
    button{
      border:1px solid var(--grid);
      background:#fff;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:650;
    }
    button:hover{background:#f6f6f6;}
    .twoCol{display:grid; grid-template-columns: 1fr 1fr; gap:14px; padding:12px 14px;}
    .mini{font-size:12px; color:var(--muted);}
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
      .kpi{grid-template-columns: 1fr 1fr;}
      .twoCol{grid-template-columns: 1fr;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Tournament Planner + Live Dashboard (FloArena)</h1>
    <p class="sub">Orange fields are user input. Everything else calculates automatically. This version adds a “start-of-tournament” planning card + weight-class balancing between gyms/mats.</p>

    <div class="grid">
      <!-- Planner -->
      <div class="card">
        <h2>Start-of-tournament planner</h2>

        <div class="row">
          <div class="field">
            <div class="label">Tournament level</div>
            <select id="level" class="user">
              <option value="hs">HS</option>
              <option value="jy">JH / Youth</option>
            </select>
          </div>
          <div class="field">
            <div class="label">Format</div>
            <select id="format" class="user">
              <option value="de_top6">Double elimination — places 1st–6th (1st/2nd/3rd/4th/5th/6th)</option>
            </select>
          </div>
          <div class="field small">
            <div class="label">Days</div>
            <select id="days" class="user">
              <option value="2">2-day</option>
              <option value="1">1-day</option>
            </select>
          </div>
          <div class="field small">
            <div class="label">Weight classes</div>
            <input id="numWeights" class="user" type="number" min="1" step="1" value="13"/>
          </div>
        </div>

        <div class="row">
          <div class="field small">
            <div class="label">Day 1 start</div>
            <input id="day1Start" class="user" type="time" value="16:00"/>
          </div>
          <div class="field small">
            <div class="label">Day 1 end (optional)</div>
            <input id="day1End" class="user" type="time" value="22:00"/>
          </div>
          <div class="field small">
            <div class="label">Day 2 start</div>
            <input id="day2Start" class="user" type="time" value="09:00"/>
          </div>
          <div class="field small">
            <div class="label">Day 2 hard stop (optional)</div>
            <input id="day2End" class="user" type="time" value="17:00"/>
          </div>
          <div class="field small">
            <div class="label">Assumed pace (bouts / mat / hr)</div>
            <input id="pace" class="user" type="number" min="6" max="20" step="0.5" value="12"/>
            <div class="mini" id="paceHint"></div>
          </div>
        </div>

        <div class="twoCol">
          <div>
            <div class="label">Wrestlers per weight</div>
            <table id="weightsTable">
              <thead>
                <tr>
                  <th style="width:40%">Weight</th>
                  <th style="width:30%" class="right">Wrestlers</th>
                  <th style="width:30%" class="right">Bouts (est.)</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <th>Total</th>
                  <th class="right" id="totalWrestlers">0</th>
                  <th class="right" id="totalBouts">0</th>
                </tr>
              </tfoot>
            </table>
          </div>

          <div>
            <div class="label">Gyms / locations</div>
            <table id="locTable">
              <thead>
                <tr>
                  <th style="width:40%">Location</th>
                  <th style="width:20%" class="right"># Mats</th>
                  <th style="width:40%" class="right">Assigned bouts</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <th>Total</th>
                  <th class="right" id="totalMats">0</th>
                  <th class="right" id="totalAssignedBouts">0</th>
                </tr>
              </tfoot>
            </table>

            <div class="actions">
              <button id="addLoc">+ Add location</button>
              <button id="resetLoc">Reset locations</button>
              <button id="rebalance">Rebalance weights across gyms</button>
            </div>

            <div style="padding:0 14px 12px 14px" class="mini">
              Balancing logic: assigns heavier “bouts” weight classes to gyms so each gym’s <b>bouts per mat</b> load stays as even as possible.
            </div>

            <table id="assignmentTable" style="margin:0 14px 14px 14px; width: calc(100% - 28px);">
              <thead>
                <tr>
                  <th style="width:32%">Location</th>
                  <th style="width:48%">Assigned weights</th>
                  <th style="width:20%" class="right">Bouts</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

          </div>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="k">Total mats</div>
            <div class="v" id="kpiMats">-</div>
          </div>
          <div class="box">
            <div class="k">Estimated total hours (all mats)</div>
            <div class="v" id="kpiHours">-</div>
          </div>
          <div class="box">
            <div class="k">Day 1 capacity (bouts)</div>
            <div class="v" id="kpiDay1Cap">-</div>
          </div>
          <div class="box">
            <div class="k">Plan status</div>
            <div class="v" id="kpiStatus">-</div>
          </div>
        </div>

        <div style="padding:0 14px 14px 14px">
          <div class="label">Recommended Day 1 stop point (time-based)</div>
          <div id="stopPointText" style="font-weight:750; font-size:13px;">-</div>
          <div class="mini" id="stopPointMini"></div>
        </div>

        <div class="note">
          This recommendation is intentionally practical (time-based), because Flo brackets vary by byes and small brackets. Once you’re close to the event, refine with “matches remaining by location” + hourly pace tracking.
        </div>
      </div>

      <!-- Simulator -->
      <div class="card">
        <h2>What-if simulator (end time)</h2>

        <div class="row">
          <div class="field">
            <div class="label">Scenario: mats available</div>
            <input id="simMats" class="user" type="number" min="1" step="1" value="8"/>
          </div>
          <div class="field">
            <div class="label">Scenario: pace (bouts / mat / hr)</div>
            <input id="simPace" class="user" type="number" min="6" max="20" step="0.5" value="12"/>
          </div>
          <div class="field">
            <div class="label">Tournament start (used for end time)</div>
            <input id="simStart" class="user" type="time" value="09:00"/>
          </div>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="k">Total bouts (from planner)</div>
            <div class="v" id="simTotalBouts">-</div>
          </div>
          <div class="box">
            <div class="k">Estimated duration</div>
            <div class="v" id="simDuration">-</div>
          </div>
          <div class="box">
            <div class="k">Estimated end time</div>
            <div class="v" id="simEnd">-</div>
          </div>
          <div class="box">
            <div class="k">Delta vs planner</div>
            <div class="v" id="simDelta">-</div>
          </div>
        </div>

        <div style="padding:0 14px 14px 14px">
          <div class="label">Matches remaining by location (optional, live)</div>
          <div class="mini">If you’re mid-tournament, enter remaining matches per gym below. This estimates finish time from remaining matches at your scenario pace.</div>
        </div>

        <div style="padding:0 14px 14px 14px">
          <table id="remainingTable">
            <thead>
              <tr>
                <th style="width:40%">Location</th>
                <th style="width:20%" class="right"># Mats</th>
                <th style="width:40%" class="right">Matches remaining</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th>Total</th>
                <th class="right" id="remTotalMats">0</th>
                <th class="right" id="remTotal">0</th>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="k">Remaining hours (scenario pace)</div>
            <div class="v" id="remHours">-</div>
          </div>
          <div class="box">
            <div class="k">Estimated finish time (from now)</div>
            <div class="v" id="remEnd">-</div>
          </div>
          <div class="box">
            <div class="k">Remaining matches / mat</div>
            <div class="v" id="remMPM">-</div>
          </div>
          <div class="box">
            <div class="k">Reset</div>
            <div class="v" style="font-size:12px; font-weight:650; color:var(--muted);"><button id="resetAll">Reset all</button></div>
          </div>
        </div>

        <div class="note">
          Next upgrade: “Drop mats at X time” + “Finals on 1 mat” bottleneck simulation.
        </div>
      </div>
    </div>
  </div>

<script>
  const pad2 = n => String(n).padStart(2, "0");
  function parseTimeToMinutes(hhmm){
    if(!hhmm) return null;
    const [h,m] = hhmm.split(":").map(Number);
    if(Number.isNaN(h) || Number.isNaN(m)) return null;
    return h*60+m;
  }
  function minutesToTime(mins){
    mins = ((mins % 1440) + 1440) % 1440;
    const h = Math.floor(mins/60), m = mins%60;
    return `${pad2(h)}:${pad2(m)}`;
  }
  function fmt(n, d=2){
    if(n === null || n === undefined || Number.isNaN(n) || !Number.isFinite(n)) return "-";
    return n.toFixed(d).replace(/\.00$/,"");
  }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function el(id){ return document.getElementById(id); }

  // Double elimination, placing 1st–6th (single 5th-place winner => includes 5th/6th match)
  function boutsTop6(n){
    n = Math.floor(Number(n||0));
    if(n <= 1) return 0;
    if(n === 2) return 1;
    if(n === 3) return 3;
    if(n === 4) return 5;
    return 2*n - 5; // n >= 5
  }

  const defaultWeights = Array.from({length:13}, (_,i)=>({ name:`W${i+1}`, wrestlers:16 }));
  const defaultLocations = [{ name:"Gym A", mats:6 }, { name:"Gym B", mats:2 }];

  const LS_KEY = "flo_planner_v2";
  function loadState(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || "null") || null; }
    catch(e){ return null; }
  }
  function saveState(){
    const st = {
      level: el("level").value,
      days: el("days").value,
      numWeights: Number(el("numWeights").value||13),
      day1Start: el("day1Start").value,
      day1End: el("day1End").value,
      day2Start: el("day2Start").value,
      day2End: el("day2End").value,
      pace: Number(el("pace").value||12),
      weights,
      locations,
      remainingRows,
      simMats: Number(el("simMats").value||8),
      simPace: Number(el("simPace").value||12),
      simStart: el("simStart").value
    };
    localStorage.setItem(LS_KEY, JSON.stringify(st));
  }
  function resetState(){
    localStorage.removeItem(LS_KEY);
    window.location.reload();
  }

  let state = loadState();
  let weights = state?.weights || JSON.parse(JSON.stringify(defaultWeights));
  let locations = state?.locations || JSON.parse(JSON.stringify(defaultLocations));

  function makeRemainingFromLocations(locs){
    return locs.map(l => ({ name:l.name, mats:Number(l.mats)||0, remaining:0 }));
  }
  let remainingRows = state?.remainingRows || makeRemainingFromLocations(locations);

  function initFromState(){
    if(!state) return;
    el("level").value = state.level || "hs";
    el("days").value = state.days || "2";
    el("numWeights").value = state.numWeights ?? 13;
    el("day1Start").value = state.day1Start || "16:00";
    el("day1End").value = state.day1End || "22:00";
    el("day2Start").value = state.day2Start || "09:00";
    el("day2End").value = state.day2End || "17:00";
    el("pace").value = state.pace ?? 12;
    el("simMats").value = state.simMats ?? 8;
    el("simPace").value = state.simPace ?? 12;
    el("simStart").value = state.simStart || "09:00";
  }

  function setPaceDefaults(){
    const lvl = el("level").value;
    const hint = (lvl === "hs") ? "Default HS pace is 12." : "Default JH/Youth pace is 14.";
    el("paceHint").textContent = hint;
    if(!state){
      const p = (lvl === "hs") ? 12 : 14;
      el("pace").value = p;
      el("simPace").value = p;
    }
  }

  function syncRemainingNames(){
    const newRem = [];
    locations.forEach((l, idx) => {
      const prev = remainingRows[idx];
      newRem.push({
        name: l.name,
        mats: Number(l.mats)||0,
        remaining: prev ? Number(prev.remaining)||0 : 0
      });
    });
    remainingRows = newRem;
  }

  function renderWeights(){
    const n = clamp(Math.floor(Number(el("numWeights").value||13)), 1, 30);
    while(weights.length < n) weights.push({ name:`W${weights.length+1}`, wrestlers:0 });
    while(weights.length > n) weights.pop();

    const tbody = document.querySelector("#weightsTable tbody");
    tbody.innerHTML = "";
    weights.forEach((w, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="user" data-wi="${idx}" data-f="name" value="${w.name}"></td>
        <td class="right"><input class="user right" type="number" min="0" step="1" data-wi="${idx}" data-f="wrestlers" value="${w.wrestlers}"></td>
        <td class="right" id="wb-${idx}">-</td>
      `;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", (e) => {
        const i = Number(e.target.dataset.wi);
        const f = e.target.dataset.f;
        let v = e.target.value;
        if(f === "wrestlers") v = Number(v||0);
        weights[i][f] = v;
        rebalanceAssignments();
        recalc();
        saveState();
      });
    });
  }

  function renderLocations(){
    const tbody = document.querySelector("#locTable tbody");
    tbody.innerHTML = "";
    locations.forEach((loc, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="user" data-li="${idx}" data-f="name" value="${loc.name}"></td>
        <td class="right"><input class="user right" type="number" min="0" step="1" data-li="${idx}" data-f="mats" value="${loc.mats}"></td>
        <td class="right" id="lab-${idx}">-</td>
      `;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", (e) => {
        const i = Number(e.target.dataset.li);
        const f = e.target.dataset.f;
        let v = e.target.value;
        if(f === "mats") v = Number(v||0);
        locations[i][f] = v;
        syncRemainingNames();
        renderRemaining();
        rebalanceAssignments();
        recalc();
        saveState();
      });
    });
  }

  function renderRemaining(){
    const tbody = document.querySelector("#remainingTable tbody");
    tbody.innerHTML = "";
    remainingRows.forEach((r, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.name}</td>
        <td class="right">${Number(r.mats)||0}</td>
        <td class="right"><input class="user right" type="number" min="0" step="1" data-ri="${idx}" value="${r.remaining ?? 0}"></td>
      `;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll("input[data-ri]").forEach(inp => {
      inp.addEventListener("input", (e) => {
        const i = Number(e.target.dataset.ri);
        remainingRows[i].remaining = Number(e.target.value||0);
        recalc();
        saveState();
      });
    });
  }

  // Balancing (greedy by lowest bouts/mat load)
  let assignments = [];
  function rebalanceAssignments(){
    const weightsWithBouts = weights.map((w,i)=>({ idx:i, bouts:boutsTop6(w.wrestlers) }))
      .sort((a,b)=>b.bouts-a.bouts);
    const loads = locations.map((l,i)=>({ locIdx:i, mats:Number(l.mats)||0, weights:[], bouts:0 }));
    weightsWithBouts.forEach(wb=>{
      let best=-1, bestScore=Infinity;
      loads.forEach((l,i)=>{
        if(l.mats<=0) return;
        const score = l.bouts / l.mats;
        if(score < bestScore){ bestScore=score; best=i; }
      });
      if(best>=0){
        loads[best].weights.push(wb.idx);
        loads[best].bouts += wb.bouts;
      }
    });
    assignments = loads;
    renderAssignments();
  }

  function renderAssignments(){
    const tbody = document.querySelector("#assignmentTable tbody");
    tbody.innerHTML = "";
    assignments.forEach(a=>{
      const loc = locations[a.locIdx];
      const names = a.weights.map(i=>weights[i]?.name).filter(Boolean);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${loc?.name ?? "?"}</td>
        <td>${names.length ? names.join(", ") : "<span style='color:var(--muted)'>—</span>"}</td>
        <td class="right">${a.bouts}</td>
      `;
      tbody.appendChild(tr);
      const cell = document.getElementById(`lab-${a.locIdx}`);
      if(cell) cell.textContent = a.bouts;
    });
  }

  function recalc(){
    let totalW=0, totalB=0;
    weights.forEach((w, idx)=>{
      const n = Number(w.wrestlers)||0;
      const b = boutsTop6(n);
      totalW += n;
      totalB += b;
      const cell = document.getElementById(`wb-${idx}`);
      if(cell) cell.textContent = b;
    });
    el("totalWrestlers").textContent = totalW;
    el("totalBouts").textContent = totalB;

    el("simTotalBouts").textContent = totalB;

    const totalMats = locations.reduce((s,l)=>s+(Number(l.mats)||0),0);
    el("totalMats").textContent = totalMats;
    el("kpiMats").textContent = totalMats>0 ? totalMats : "-";

    const pace = Number(el("pace").value||12);
    const totalHours = (totalMats>0 && pace>0) ? (totalB/(totalMats*pace)) : null;
    el("kpiHours").textContent = totalHours!==null ? `${fmt(totalHours,2)} hrs` : "-";

    const day1Start = parseTimeToMinutes(el("day1Start").value);
    const day1End = parseTimeToMinutes(el("day1End").value);
    const day1Hours = (day1Start!==null && day1End!==null) ? Math.max(0, (day1End-day1Start)/60) : null;
    const day1Cap = (day1Hours!==null && totalMats>0 && pace>0) ? (day1Hours*totalMats*pace) : null;
    el("kpiDay1Cap").textContent = day1Cap!==null ? `${Math.round(day1Cap)} bouts` : "-";

    // status
    const days = Number(el("days").value||2);
    let statusText="-", statusClass="badge";
    if(days === 1){
      if(totalHours!==null && day1Hours!==null){
        const fits = totalHours <= day1Hours;
        statusText = fits ? "Fits in 1 day" : "Likely runs long";
        statusClass = fits ? "badge good" : "badge warn";
      }
    }else{
      if(day1Cap!==null && totalB>0){
        const pct = clamp(day1Cap/totalB, 0, 1);
        if(pct >= 0.60){ statusText="Strong split"; statusClass="badge good"; }
        else if(pct >= 0.45){ statusText="OK split"; statusClass="badge warn"; }
        else { statusText="Saturday heavy"; statusClass="badge bad"; }
      }
    }
    el("kpiStatus").innerHTML = `<span class="${statusClass}">${statusText}</span>`;

    // stop point text (heuristic)
    const stopText = el("stopPointText");
    const stopMini = el("stopPointMini");
    if(days === 1){
      if(totalHours!==null && day1Start!==null){
        stopText.textContent = `Expected finish around ${minutesToTime(day1Start + Math.round(totalHours*60))} (projected).`;
        stopMini.textContent = `Assumes ${pace} bouts/mat/hr on ${totalMats} mats.`;
      }else{
        stopText.textContent="-"; stopMini.textContent="";
      }
    }else{
      if(day1Cap!==null && totalB>0){
        const pct = clamp(day1Cap/totalB,0,1);
        let rec;
        if(pct >= 0.62) rec = "Finish through Championship R16 and try to start Quarterfinals if pace holds.";
        else if(pct >= 0.52) rec = "Finish through Championship R16 and at least the first wrestleback layer (early consolations).";
        else if(pct >= 0.42) rec = "Aim to complete early championship rounds and as many early consolations as possible; Saturday will be heavy.";
        else rec = "Friday is too short for clean round boundaries. Add mats/hours or expect a late Saturday.";
        stopText.textContent = rec;
        stopMini.textContent = `Friday capacity ≈ ${Math.round(day1Cap)} bouts (~${fmt(day1Hours,1)} hrs) ≈ ${(pct*100).toFixed(0)}% of ${totalB} projected bouts.`;
      }else{
        stopText.textContent="-"; stopMini.textContent="";
      }
    }

    // simulator (projected)
    const simMats = Number(el("simMats").value||0);
    const simPace = Number(el("simPace").value||0);
    const simStart = parseTimeToMinutes(el("simStart").value);
    const simHours = (simMats>0 && simPace>0) ? (totalB/(simMats*simPace)) : null;
    el("simDuration").textContent = simHours!==null ? `${fmt(simHours,2)} hrs` : "-";
    el("simEnd").textContent = (simHours!==null && simStart!==null) ? minutesToTime(simStart + Math.round(simHours*60)) : "-";
    if(simHours!==null && totalHours!==null){
      const delta = simHours - totalHours;
      const sign = delta >= 0 ? "+" : "−";
      el("simDelta").textContent = `${sign}${fmt(Math.abs(delta),2)} hrs`;
    }else{
      el("simDelta").textContent = "-";
    }

    // remaining (live)
    const remTotalMats = remainingRows.reduce((s,r)=>s+(Number(r.mats)||0),0);
    const remTotal = remainingRows.reduce((s,r)=>s+(Number(r.remaining)||0),0);
    el("remTotalMats").textContent = remTotalMats;
    el("remTotal").textContent = remTotal;

    const remHours = (remTotalMats>0 && simPace>0) ? (remTotal/(remTotalMats*simPace)) : null;
    el("remHours").textContent = remHours!==null ? `${fmt(remHours,2)} hrs` : "-";
    el("remMPM").textContent = remTotalMats>0 ? fmt(remTotal/remTotalMats,2) : "-";

    const now = new Date();
    const nowMins = now.getHours()*60 + now.getMinutes();
    el("remEnd").textContent = remHours!==null ? minutesToTime(nowMins + Math.round(remHours*60)) : "-";
  }

  function bind(){
    ["level","days","numWeights","day1Start","day1End","day2Start","day2End","pace"].forEach(id=>{
      el(id).addEventListener("input", ()=>{
        if(id==="level"){ setPaceDefaults(); }
        renderWeights();
        rebalanceAssignments();
        syncRemainingNames();
        renderLocations();
        renderRemaining();
        recalc();
        saveState();
      });
    });
    ["simMats","simPace","simStart"].forEach(id=>{
      el(id).addEventListener("input", ()=>{ recalc(); saveState(); });
    });

    el("addLoc").addEventListener("click", ()=>{
      locations.push({ name:`Location ${locations.length+1}`, mats:0 });
      syncRemainingNames();
      renderLocations();
      renderRemaining();
      rebalanceAssignments();
      recalc();
      saveState();
    });
    el("resetLoc").addEventListener("click", ()=>{
      if(!confirm("Reset locations to defaults?")) return;
      locations = JSON.parse(JSON.stringify(defaultLocations));
      syncRemainingNames();
      renderLocations();
      renderRemaining();
      rebalanceAssignments();
      recalc();
      saveState();
    });
    el("rebalance").addEventListener("click", ()=>{
      rebalanceAssignments();
      recalc();
      saveState();
    });
    el("resetAll").addEventListener("click", ()=>{
      if(!confirm("Reset everything (inputs + saved state)?")) return;
      resetState();
    });
  }

  // boot
  initFromState();
  setPaceDefaults();
  renderWeights();
  renderLocations();
  syncRemainingNames();
  renderRemaining();
  rebalanceAssignments();
  bind();
  recalc();
  saveState();
</script>
</body>
</html>
