<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FloArena Tournament Suite (Planner + Live Dashboard)</title>
  <style>
    :root{
      --bg:#05060a;
      --card:#11131b;
      --panel:#11131b;
      --panel-soft:#141824;
      --grid:rgba(255,255,255,0.08);
      --grid-strong:rgba(255,255,255,0.16);
      --text:#f2f2f2;
      --muted:#9aa0a6;
      --accent:#1e88e5;

      /* Status colors */
      --good:#37d67a;
      --warn:#ffb020;
      --bad:#ff5b5b;

      /* User input highlight (subtle) */
      --user-bg: rgba(30,136,229,0.16);
      --user-border: rgba(30,136,229,0.75);
    }
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .wrap{max-width:1400px; margin:0 auto; padding:18px;}
    h1{font-size:20px; margin:0 0 6px;}
    .sub{color:var(--muted); margin:0 0 16px; font-size:13px;}
    .grid{display:grid; grid-template-columns: 1fr; gap:16px;}
    .grid3{display:grid; grid-template-columns: 1fr; gap:16px; margin-top:16px;}
    .card{background:var(--card); border:1px solid var(--grid); border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); overflow:hidden;}
    .card h2{margin:0; padding:12px 14px; font-size:14px; background:#f3f3f3; border-bottom:1px solid var(--grid);}
    .row{display:flex; gap:10px; padding:12px 14px; align-items:end; flex-wrap:wrap;}
    .field{min-width:170px; flex:1;}
    .field.small{min-width:130px; flex:0.75;}
    .label{font-size:12px; color:var(--muted); margin:0 0 6px;}
    input, select{
      width:100%;
      box-sizing:border-box;
      padding:7px 9px;
      border:1px solid #bdbdbd;
      border-radius:10px;
      font-size:13px;
      background:#fff;
      color:var(--text);
      outline:none;
    }
    input.user, select.user{
      background:var(--input);
      color:var(--inputText);
      border-color:#d0831f;
      font-weight:700;
    }
    table{border-collapse:collapse; width:100%;}
    th,td{border:1px solid var(--grid); padding:8px 10px; font-size:13px; vertical-align:middle;}
    th{background:#f8f8f8; text-align:left; font-weight:650;}
    .right{text-align:right;}
    .kpi{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; padding:12px 14px;}
    .kpi.k3{grid-template-columns: repeat(3, 1fr);}
    .kpi .box{border:1px solid var(--grid); border-radius:12px; padding:10px;}
    .kpi .box .k{font-size:11px; color:var(--muted);}
    .kpi .box .v{font-size:18px; font-weight:850; margin-top:4px;}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; border:1px solid var(--grid); background:#fff;}
    .badge.good{color:var(--good); border-color:#a5d6a7; background:#e8f5e9;}
    .badge.warn{color:var(--warn); border-color:#ffcc80; background:#fff3e0;}
    .badge.bad{color:var(--bad); border-color:#ef9a9a; background:#ffebee;}
    .note{padding:10px 14px; color:var(--muted); font-size:12px; border-top:1px solid var(--grid);}
    .actions{display:flex; gap:10px; padding:12px 14px; border-top:1px solid var(--grid); background:#fff; flex-wrap:wrap;}
    button{
      border:1px solid var(--grid);
      background:#fff;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:650;
    }
    button:hover{background:#f6f6f6;}
    .twoCol{display:grid; grid-template-columns: 1fr; gap:14px; padding:12px 14px;}
    .mini{font-size:12px; color:var(--muted);}
    .small{font-size:12px; color:var(--muted);}
    .pill{display:inline-flex; gap:8px; align-items:center;}
    .pill input{width:auto;}
    @media (max-width: 980px){
      .grid, .grid3{display:grid; grid-template-columns: 1fr; gap:16px; margin-top:16px;}
      .kpi{grid-template-columns: 1fr 1fr;}
      .kpi.k3{grid-template-columns: 1fr;}
      .twoCol{display:grid; grid-template-columns: 1fr; gap:14px; padding:12px 14px;}
    }
  
    /* Matside dark theme overrides */
    .card h2{background:var(--panel) !important;}
    th{background:var(--panel) !important;}
    button{color:var(--text) !important; background:#161616 !important; border-color:var(--grid) !important;}
    button:hover{background:#1d1d1d !important;}
    input, select, textarea{background:#0f0f0f; color:var(--text); border-color:var(--grid);}
    input.user, select.user{background:var(--input) !important; color:var(--inputText) !important; border-color:#d0831f !important;}
    textarea{background:#0f0f0f; color:var(--text);}
    .badge{background:#111 !important; color:var(--text);}
    a{color:#ffffff;}
    a:hover{opacity:.9;}


    /* Matside polish overrides */
    body{background:var(--bg) !important; color:var(--text) !important;}
    .card{background:var(--card) !important; border-color:var(--grid) !important;}
    .card h2{background:var(--panel) !important; border-bottom-color:var(--grid) !important;}
    th{background:var(--panel) !important;}
    td, th{border-color:var(--grid) !important;}
    .note{border-top-color:var(--grid) !important;}
    .actions{background:transparent !important; border-top-color:var(--grid) !important;}

    input, select, textarea{
      background:var(--panel-soft) !important;
      color:var(--text) !important;
      border-color:var(--grid-strong) !important;
    }
    input:focus, select:focus, textarea:focus{
      border-color: var(--user-border) !important;
      box-shadow: 0 0 0 3px rgba(30,136,229,0.18) !important;
    }

    /* Subtle highlight for user-input fields */
    input.user, select.user{
      background: var(--user-bg) !important;
      border-color: var(--user-border) !important;
      color: var(--text) !important;
      font-weight: 700;
    }

    button{
      color: var(--text) !important;
      background: transparent !important;
      border-color: var(--grid-strong) !important;
    }
    button:hover{
      background: rgba(255,255,255,0.06) !important;
      border-color: rgba(30,136,229,0.45) !important;
    }

    .badge{background:rgba(255,255,255,0.03) !important; border-color:var(--grid) !important;}
    a{color: var(--text) !important;}
    a:hover{opacity:.9;}

</style>
</head>
<body>
  <div class="wrap">
    <h1>FloArena Tournament Suite</h1>
    <p class="sub">All modules in one page. Orange fields are user input. Everything else updates automatically. Saved locally in your browser.</p>

    <div class="grid">
      <div class="card">
        <h2>Module 1 — Start-of-tournament planner</h2>

        <div class="row">
          <div class="field">
            <div class="label">Tournament level</div>
            <select id="level" class="user">
              <option value="hs">HS</option>
              <option value="jy">JH / Youth</option>
            </select>
          </div>
          <div class="field">
            <div class="label">Format</div>
            <select id="format" class="user">
              <option value="de_top4">Double elimination — places 1st–4th</option>
              <option value="de_top6">Double elimination — places 1st–6th</option>
              <option value="de_top8">Double elimination — places 1st–8th</option>
            </select>
          </div>
          <div class="field small">
            <div class="label">Days</div>
            <select id="days" class="user">
              <option value="2">2-day</option>
              <option value="1">1-day</option>
            </select>
          </div>
          <div class="field small">
            <div class="label">Weight classes</div>
            <input id="numWeights" class="user" type="number" min="1" step="1" value="13"/>
          </div>
        </div>

        <div class="row">
          <div class="field small">
            <div class="label">Day 1 start</div>
            <input id="day1Start" class="user" type="time" value="16:00"/>
          </div>
          <div class="field small">
            <div class="label">Day 1 end</div>
            <input id="day1End" class="user" type="time" value="22:00"/>
          </div>
          <div class="field small">
            <div class="label">Day 2 start</div>
            <input id="day2Start" class="user" type="time" value="09:00"/>
          </div>
          <div class="field small">
            <div class="label">Assumed pace (bouts / mat / hr)</div>
            <input id="pace" class="user" type="number" min="6" max="20" step="0.5" value="12"/>
            <div class="mini" id="paceHint"></div>
          </div>
        </div>

        <div class="twoCol">
          <div>
            <div class="label">Wrestlers per weight</div>
            <table id="weightsTable">
              <thead>
                <tr>
                  <th style="width:40%">Weight</th>
                  <th style="width:30%" class="right">Wrestlers</th>
                  <th style="width:30%" class="right">Bouts (est.)</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <th>Total</th>
                  <th class="right" id="totalWrestlers">0</th>
                  <th class="right" id="plannerTotalBouts">0</th>
                </tr>
              </tfoot>
            </table>
          </div>

          <div>
            <div class="label">Gym / locations (shared across modules)</div>
            <div class="small" style="padding:0 0 10px 0;">Set mats here once; Live Dashboard + What-if use the same mats automatically.</div>
            <table id="locTablePlanner">
              <thead>
                <tr>
                  <th style="width:40%">Location</th>
                  <th style="width:20%" class="right"># Mats</th>
                  <th style="width:40%" class="right">Assigned bouts</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <th>Total</th>
                  <th class="right" id="totalMatsPlanner">0</th>
                  <th class="right" id="totalAssignedBouts">0</th>
                </tr>
              </tfoot>
            </table>

            <div class="actions">
              <button id="addLoc">+ Add location</button>
              <button id="resetLoc">Reset locations</button>
              <button id="rebalance">Rebalance weights across gyms</button>
            </div>

            <div style="padding:0 14px 12px 14px" class="mini">
              Balancing logic: assigns heavier “bouts” weights to gyms to keep <b>bouts per mat</b> as even as possible.
            </div>

            <table id="assignmentTable" style="margin:0 14px 14px 14px; width: calc(100% - 28px);">
              <thead>
                <tr>
                  <th style="width:32%">Location</th>
                  <th style="width:48%">Assigned weights</th>
                  <th style="width:20%" class="right">Bouts</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

          </div>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="k">Total mats</div>
            <div class="v" id="kpiMats">-</div>
          </div>
          <div class="box">
            <div class="k">Estimated total hours (all mats)</div>
            <div class="v" id="kpiHours">-</div>
          </div>
          <div class="box">
            <div class="k">Friday capacity (bouts)</div>
            <div class="v" id="kpiDay1Cap">-</div>
          </div>
          <div class="box">
            <div class="k">Plan status</div>
            <div class="v" id="kpiStatus">-</div>
          </div>
        </div>

        <div style="padding:0 14px 14px 14px">
          <div class="label">Recommended Day 1 stop point</div>
          <div id="stopPointText" style="font-weight:750; font-size:13px;">-</div>
          <div class="mini" id="stopPointMini"></div>
        </div>

        <div class="note">
          Planner estimates bouts for double-elimination with placement to 4/6/8 (Flo-style).
        </div>
      </div>

      <div class="card">
        <h2>Module 2 — Live dashboard (matches remaining + hourly pace)</h2>

        <div style="padding:12px 14px" class="small">
          Enter <b>matches remaining</b> per location. It calculates “matches per mat” and overall remaining load.
        </div>

        <table id="locTableLive">
          <thead>
            <tr>
              <th style="width:34%">Location</th>
              <th style="width:16%" class="right"># Mats</th>
              <th style="width:22%" class="right">Matches remaining</th>
              <th style="width:28%" class="right">Matches / mat</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <th>Total</th>
              <th class="right" id="liveTotalMats">0</th>
              <th class="right" id="liveTotalRemaining">0</th>
              <th class="right" id="liveOverallMPM">-</th>
            </tr>
          </tfoot>
        </table>

        <div class="row">
          <div class="field">
            <div class="label">Total estimated bouts</div>
            <div class="pill">
              <input id="usePlannerTotal" type="checkbox" checked />
              <span class="mini">Use Planner total</span>
            </div>
            <input id="totalBouts" class="user" type="number" min="0" step="1" value="0" />
          </div>
          <div class="field small">
            <div class="label">Start time</div>
            <input id="startTime" class="user" type="time" value="09:00" />
          </div>
          <div class="field small">
            <div class="label">Level</div>
            <select id="dashLevel" class="user">
              <option value="hs">HS</option>
              <option value="jh">JH / Youth</option>
            </select>
          </div>
        </div>

        <div class="kpi k3">
          <div class="box">
            <div class="k">Bouts completed (entered)</div>
            <div class="v" id="boutsCompleted">0</div>
          </div>
          <div class="box">
            <div class="k">Avg bouts / hr (overall)</div>
            <div class="v" id="avgPerHour">-</div>
          </div>
          <div class="box">
            <div class="k">Estimated end time</div>
            <div class="v" id="estEndTime">-</div>
          </div>
        </div>

        <div style="padding:12px 14px">
          <table id="hourTable">
            <thead>
              <tr>
                <th style="width:20%">Start</th>
                <th style="width:20%">End</th>
                <th style="width:30%" class="right">Completed (this hour)</th>
                <th style="width:30%" class="right">Per-mat average</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="actions">
          <button id="addHour">+ Add hour row</button>
          <button id="clearHours">Clear hour inputs</button>
        </div>

        <div class="note">
          Tip: even 2–3 filled hours gives you a usable “end time” forecast from your real pace.
        </div>
      </div>
    </div>

    <div class="grid3">
      <div class="card">
        <h2>Module 3 — What-if simulator (end time)</h2>

        <div class="row">
          <div class="field small">
            <div class="label">Scenario: mats available</div>
            <input id="simMats" class="user" type="number" min="1" step="1" value="8"/>
          </div>
          <div class="field small">
            <div class="label">Scenario: pace (bouts / mat / hr)</div>
            <input id="simPace" class="user" type="number" min="6" max="20" step="0.5" value="12"/>
          </div>
          <div class="field small">
            <div class="label">Tournament start</div>
            <input id="simStart" class="user" type="time" value="09:00"/>
          </div>
          <div class="field">
            <div class="label">Total bouts (from Planner unless overridden)</div>
            <input id="simTotalBouts" class="user" type="number" min="0" step="1" value="0"/>
            <div class="mini">If you want this driven by live pace instead of projections, use Module 2.</div>
          </div>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="k">Estimated duration</div>
            <div class="v" id="simDuration">-</div>
          </div>
          <div class="box">
            <div class="k">Estimated end time</div>
            <div class="v" id="simEnd">-</div>
          </div>
          <div class="box">
            <div class="k">Delta vs planner</div>
            <div class="v" id="simDelta">-</div>
          </div>
          <div class="box">
            <div class="k">Note</div>
            <div class="v" style="font-size:12px; font-weight:650; color:var(--muted);">Next: drop-mats + finals bottleneck.</div>
          </div>
        </div>

        <div class="note">
          This module answers “what happens if we drop to 4 mats?” instantly.
        </div>
      </div>

      <div class="card">
        <h2>Module 4 — Utilities</h2>
        <div style="padding:12px 14px" class="small">
          This page stores everything locally in your browser (localStorage). Use these buttons if you want a clean slate.
        </div>
        <div class="actions">
          <button id="resetAll">Reset everything</button>
          <button id="exportJson">Export saved data (JSON)</button>
          <button id="importJson">Import saved data (JSON)</button>
        </div>
        <div style="padding:0 14px 14px 14px">
          <textarea id="jsonBox" style="width:100%; height:240px; border:1px solid var(--grid); border-radius:12px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px;" placeholder="Export/import data here..."></textarea>
        </div>
        <div class="note">
          Export/import is handy if you want to move the plan from your laptop to a Chromebook mat table.
        </div>
      </div>
    </div>
  </div>

<script>
  const pad2 = n => String(n).padStart(2, "0");
  function parseTimeToMinutes(hhmm){
    if(!hhmm) return null;
    const [h,m] = hhmm.split(":").map(Number);
    if(Number.isNaN(h) || Number.isNaN(m)) return null;
    return h*60+m;
  }
  function minutesToTime(mins){
    mins = ((mins % 1440) + 1440) % 1440;
    const h = Math.floor(mins/60), m = mins%60;
    return `${pad2(h)}:${pad2(m)}`;
  }
  function fmt(n, d=2){
    if(n === null || n === undefined || Number.isNaN(n) || !Number.isFinite(n)) return "-";
    return n.toFixed(d).replace(/\.00$/,"");
  }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function el(id){ return document.getElementById(id); }

  function boutsTop6(n){
    n = Math.floor(Number(n||0));
    if(n <= 1) return 0;
    if(n === 2) return 1;
    if(n === 3) return 3;
    if(n === 4) return 5;
    return 2*n - 5;
  }

  function boutsTop4(n){
    // Top-4 is top-6 minus the single 5th/6th placement bout (typical Flo-style)
    n = Math.floor(Number(n||0));
    if(n <= 1) return 0;
    if(n === 2) return 1;
    if(n === 3) return 3;
    if(n === 4) return 4;
    return Math.max(0, boutsTop6(n) - 1);
  }

  function boutsTop8(n){
    // Top-8 is top-6 plus the single 7th/8th placement bout (typical Flo-style)
    n = Math.floor(Number(n||0));
    if(n <= 1) return 0;
    if(n === 2) return 1;
    if(n === 3) return 3;
    if(n === 4) return 5;
    return boutsTop6(n) + 1;
  }

  function boutsForFormat(n, fmt){
    switch(fmt){
      case "de_top4": return boutsTop4(n);
      case "de_top8": return boutsTop8(n);
      case "de_top6":
      default: return boutsTop6(n);
    }
  }

  const LS_KEY = "flo_all_modules_v1";
  const DEFAULTS = {
    
    format: "de_top6",level: "hs",
    days: "2",
    numWeights: 13,
    day1Start: "16:00",
    day1End: "22:00",
    day2Start: "09:00",
    pace: 12,
    weights: Array.from({length:13}, (_,i)=>({ name:`W${i+1}`, wrestlers:16 })),
    locations: [
      { name:"Gym A", mats:4, remaining:0 },
      { name:"Gym B", mats:4, remaining:0 }
    ],
    usePlannerTotal: true,
    totalBoutsOverride: 0,
    startTime: "09:00",
    dashLevel: "hs",
    hours: Array.from({length:14}, ()=>({ completed:"" })),
    simMats: 8,
    simPace: 12,
    simStart: "09:00",
    simTotalBoutsOverride: 0
  };

  function deepMerge(a,b){
    for(const k of Object.keys(b||{})){
      if(b[k] && typeof b[k] === "object" && !Array.isArray(b[k]) && a[k] && typeof a[k] === "object" && !Array.isArray(a[k])){
        a[k] = deepMerge(a[k], b[k]);
      } else {
        a[k] = b[k];
      }
    }
    return a;
  }

  function loadState(){
    try{
      const s = JSON.parse(localStorage.getItem(LS_KEY) || "null");
      return s ? deepMerge(JSON.parse(JSON.stringify(DEFAULTS)), s) : JSON.parse(JSON.stringify(DEFAULTS));
    } catch(e){
      return JSON.parse(JSON.stringify(DEFAULTS));
    }
  }
  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  let state = loadState();

  function totalMats(){
    return state.locations.reduce((s,l)=>s+(Number(l.mats)||0),0);
  }

  function initControls(){
    el("level").value = state.level;
    el("format").value = state.format || "de_top6";
    el("days").value = state.days;
    el("numWeights").value = state.numWeights;
    el("day1Start").value = state.day1Start;
    el("day1End").value = state.day1End;
    el("day2Start").value = state.day2Start;
    el("pace").value = state.pace;

    el("usePlannerTotal").checked = !!state.usePlannerTotal;
    el("totalBouts").value = state.totalBoutsOverride || 0;
    el("startTime").value = state.startTime;
    el("dashLevel").value = state.dashLevel;

    el("simMats").value = state.simMats;
    el("simPace").value = state.simPace;
    el("simStart").value = state.simStart;
    el("simTotalBouts").value = state.simTotalBoutsOverride || 0;

    setPaceDefaults(false);
  }

  function setPaceDefaults(force){
    const lvl = el("level").value;
    const hint = (lvl === "hs") ? "Default HS pace is 12." : "Default JH/Youth pace is 14.";
    el("paceHint").textContent = hint;

    const defaultP = (lvl === "hs") ? 12 : 14;
    if(force){
      el("pace").value = defaultP;
      el("simPace").value = defaultP;
      state.pace = defaultP;
      state.simPace = defaultP;
    }
  }

  function renderWeights(){
    const n = clamp(Math.floor(Number(el("numWeights").value||13)), 1, 30);
    while(state.weights.length < n) state.weights.push({ name:`W${state.weights.length+1}`, wrestlers:0 });
    while(state.weights.length > n) state.weights.pop();

    const tbody = document.querySelector("#weightsTable tbody");
    tbody.innerHTML = "";
    state.weights.forEach((w, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="user" data-wi="${idx}" data-f="name" value="${escapeHtml(w.name)}"></td>
        <td class="right"><input class="user right" type="number" min="0" step="1" data-wi="${idx}" data-f="wrestlers" value="${Number(w.wrestlers)||0}"></td>
        <td class="right" id="wb-${idx}">-</td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", (e) => {
        const i = Number(e.target.dataset.wi);
        const f = e.target.dataset.f;
        let v = e.target.value;
        if(f === "wrestlers") v = Number(v||0);
        state.weights[i][f] = v;
        rebalanceAssignments();
        recalcAll();
        saveState();
      });
    });
  }

  function renderLocations(){
    const tbodyP = document.querySelector("#locTablePlanner tbody");
    tbodyP.innerHTML = "";
    state.locations.forEach((loc, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="user" data-li="${idx}" data-f="name" value="${escapeHtml(loc.name)}"></td>
        <td class="right"><input class="user right" type="number" min="0" step="1" data-li="${idx}" data-f="mats" value="${Number(loc.mats)||0}"></td>
        <td class="right" id="lab-${idx}">-</td>
      `;
      tbodyP.appendChild(tr);
    });

    tbodyP.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", (e) => {
        const i = Number(e.target.dataset.li);
        const f = e.target.dataset.f;
        let v = e.target.value;
        if(f === "mats") v = Number(v||0);
        state.locations[i][f] = v;
        renderLocationsLive();
        rebalanceAssignments();
        recalcAll();
        saveState();
      });
    });

    renderLocationsLive();
  }

  function renderLocationsLive(){
    const tbodyL = document.querySelector("#locTableLive tbody");
    tbodyL.innerHTML = "";
    state.locations.forEach((loc, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(loc.name)}</td>
        <td class="right">${Number(loc.mats)||0}</td>
        <td class="right"><input class="user right" type="number" min="0" step="1" data-ri="${idx}" value="${Number(loc.remaining)||0}"></td>
        <td class="right" id="mpm-${idx}">-</td>
      `;
      tbodyL.appendChild(tr);
    });

    tbodyL.querySelectorAll("input[data-ri]").forEach(inp => {
      inp.addEventListener("input", (e) => {
        const i = Number(e.target.dataset.ri);
        state.locations[i].remaining = Number(e.target.value||0);
        recalcLive();
        saveState();
      });
    });
  }

  let assignments = [];
  function rebalanceAssignments(){
    const weightsWithBouts = state.weights.map((w,i)=>({ idx:i, bouts:boutsForFormat(w.wrestlers, el("format").value) }))
      .sort((a,b)=>b.bouts-a.bouts);

    const loads = state.locations.map((l,i)=>({ locIdx:i, mats:Number(l.mats)||0, weights:[], bouts:0 }));

    weightsWithBouts.forEach(wb=>{
      let best=-1, bestScore=Infinity;
      loads.forEach((l,i)=>{
        if(l.mats<=0) return;
        const score = l.bouts / l.mats;
        if(score < bestScore){ bestScore=score; best=i; }
      });
      if(best>=0){
        loads[best].weights.push(wb.idx);
        loads[best].bouts += wb.bouts;
      }
    });

    assignments = loads;
    renderAssignments();
  }

  function renderAssignments(){
    const tbody = document.querySelector("#assignmentTable tbody");
    tbody.innerHTML = "";
    assignments.forEach(a=>{
      const loc = state.locations[a.locIdx];
      const names = a.weights.map(i=>state.weights[i]?.name).filter(Boolean);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(loc?.name ?? "?")}</td>
        <td>${names.length ? names.map(escapeHtml).join(", ") : "<span style='color:var(--muted)'>—</span>"}</td>
        <td class="right">${a.bouts}</td>
      `;
      tbody.appendChild(tr);
      const cell = document.getElementById(`lab-${a.locIdx}`);
      if(cell) cell.textContent = a.bouts;
    });

    el("totalAssignedBouts").textContent = assignments.reduce((s,a)=>s+a.bouts,0);
  }

  function renderHours(){
    const tbody = document.querySelector("#hourTable tbody");
    tbody.innerHTML = "";
    const start = parseTimeToMinutes(el("startTime").value);

    state.hours.forEach((h, idx) => {
      const rowStart = (start ?? 0) + idx*60;
      const rowEnd = rowStart + 60;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span id="hs-${idx}">${minutesToTime(rowStart)}</span></td>
        <td><span id="he-${idx}">${minutesToTime(rowEnd)}</span></td>
        <td class="right">
          <input class="user right" type="number" min="0" step="1" data-hidx="${idx}" value="${h.completed}">
        </td>
        <td class="right" id="hpm-${idx}">-</td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("input[data-hidx]").forEach(inp => {
      inp.addEventListener("input", (e) => {
        const i = Number(e.target.dataset.hidx);
        state.hours[i].completed = e.target.value;
        recalcLive();
        saveState();
      });
    });
  }

  function recalcPlanner(){
    let totalW = 0, totalB = 0;
    state.weights.forEach((w, idx)=>{
      const n = Number(w.wrestlers)||0;
      const b = boutsForFormat(n, el("format").value);
      totalW += n;
      totalB += b;
      const cell = document.getElementById(`wb-${idx}`);
      if(cell) cell.textContent = b;
    });
    el("totalWrestlers").textContent = totalW;
    el("plannerTotalBouts").textContent = totalB;

    const mats = totalMats();
    el("totalMatsPlanner").textContent = mats;
    el("kpiMats").textContent = mats>0 ? mats : "-";

    const pace = Number(el("pace").value||12);
    const totalHours = (mats>0 && pace>0) ? (totalB/(mats*pace)) : null;
    el("kpiHours").textContent = totalHours!==null ? `${fmt(totalHours,2)} hrs` : "-";

    const day1Start = parseTimeToMinutes(el("day1Start").value);
    const day1End = parseTimeToMinutes(el("day1End").value);
    const day1Hours = (day1Start!==null && day1End!==null) ? Math.max(0, (day1End-day1Start)/60) : null;
    const day1Cap = (day1Hours!==null && mats>0 && pace>0) ? (day1Hours*mats*pace) : null;
    el("kpiDay1Cap").textContent = day1Cap!==null ? `${Math.round(day1Cap)} bouts` : "-";

    const days = Number(el("days").value||2);
    let statusText="-", statusClass="badge";
    if(days === 1){
      if(totalHours!==null && day1Hours!==null){
        const fits = totalHours <= day1Hours;
        statusText = fits ? "Fits in 1 day" : "Likely runs long";
        statusClass = fits ? "badge good" : "badge warn";
      }
    }else{
      if(day1Cap!==null && totalB>0){
        const pct = clamp(day1Cap/totalB, 0, 1);
        if(pct >= 0.60){ statusText="Strong split"; statusClass="badge good"; }
        else if(pct >= 0.45){ statusText="OK split"; statusClass="badge warn"; }
        else { statusText="Saturday heavy"; statusClass="badge bad"; }
      }
    }
    el("kpiStatus").innerHTML = `<span class="${statusClass}">${statusText}</span>`;

    const stopText = el("stopPointText");
    const stopMini = el("stopPointMini");
    if(days === 1){
      if(totalHours!==null && day1Start!==null){
        stopText.textContent = `Expected finish around ${minutesToTime(day1Start + Math.round(totalHours*60))} (projected).`;
        stopMini.textContent = `Assumes ${pace} bouts/mat/hr on ${mats} mats.`;
      } else {
        stopText.textContent="-"; stopMini.textContent="";
      }
    } else {
      if(day1Cap!==null && totalB>0){
        const pct = clamp(day1Cap/totalB,0,1);
        let rec;
        if(pct >= 0.62) rec = "Finish through Championship R16 and try to start Quarterfinals if pace holds.";
        else if(pct >= 0.52) rec = "Finish through Championship R16 and at least the first wrestleback layer (early consolations).";
        else if(pct >= 0.42) rec = "Aim to complete early championship rounds and as many early consolations as possible; Saturday will be heavy.";
        else rec = "Friday is too short for clean round boundaries. Add mats/hours or expect a late Saturday.";
        stopText.textContent = rec;
        stopMini.textContent = `Friday capacity ≈ ${Math.round(day1Cap)} bouts (~${fmt(day1Hours,1)} hrs) ≈ ${(pct*100).toFixed(0)}% of ${totalB} projected bouts.`;
      } else {
        stopText.textContent="-"; stopMini.textContent="";
      }
    }

    if(el("usePlannerTotal").checked){
      el("totalBouts").value = totalB;
      state.totalBoutsOverride = totalB;
    }
    if(Number(el("simTotalBouts").value||0) === 0 || el("usePlannerTotal").checked){
      el("simTotalBouts").value = totalB;
      state.simTotalBoutsOverride = totalB;
    }

    return totalB;
  }

  function recalcSim(){
    const plannerTotal = Number(el("plannerTotalBouts").textContent||0);
    const simMats = Number(el("simMats").value||0);
    const simPace = Number(el("simPace").value||0);
    const simStart = parseTimeToMinutes(el("simStart").value);
    const simTotal = Number(el("simTotalBouts").value||0);

    const baseMats = totalMats();
    const basePace = Number(el("pace").value||12);
    const baseHours = (baseMats>0 && basePace>0) ? (plannerTotal/(baseMats*basePace)) : null;

    const simHours = (simMats>0 && simPace>0) ? (simTotal/(simMats*simPace)) : null;
    el("simDuration").textContent = simHours!==null ? `${fmt(simHours,2)} hrs` : "-";
    el("simEnd").textContent = (simHours!==null && simStart!==null) ? minutesToTime(simStart + Math.round(simHours*60)) : "-";

    if(simHours!==null && baseHours!==null){
      const delta = simHours - baseHours;
      const sign = delta >= 0 ? "+" : "−";
      el("simDelta").textContent = `${sign}${fmt(Math.abs(delta),2)} hrs`;
    } else {
      el("simDelta").textContent = "-";
    }
  }

  function recalcLive(){
    const mats = totalMats();
    const totalRemaining = state.locations.reduce((s,l)=>s+(Number(l.remaining)||0),0);

    el("liveTotalMats").textContent = mats;
    el("liveTotalRemaining").textContent = totalRemaining;
    el("liveOverallMPM").textContent = mats>0 ? fmt(totalRemaining/mats,2) : "-";

    state.locations.forEach((loc, idx)=>{
      const m = Number(loc.mats)||0;
      const r = Number(loc.remaining)||0;
      const cell = document.getElementById(`mpm-${idx}`);
      if(cell) cell.textContent = m>0 ? fmt(r/m,2) : "-";
    });

    const totalBouts = Number(el("totalBouts").value || 0);
    const completedNums = state.hours
      .map(h => h.completed === "" ? null : Number(h.completed))
      .filter(v => v !== null && !Number.isNaN(v));

    const boutsCompleted = completedNums.reduce((s,n)=>s+n,0);
    const avgPerHour = completedNums.length ? (boutsCompleted / completedNums.length) : null;

    el("boutsCompleted").textContent = boutsCompleted;
    el("avgPerHour").textContent = avgPerHour!==null ? fmt(avgPerHour,2) : "-";

    const startMin = parseTimeToMinutes(el("startTime").value) ?? 0;
    state.hours.forEach((h, idx) => {
      const hs = document.getElementById(`hs-${idx}`);
      const he = document.getElementById(`he-${idx}`);
      if(hs) hs.textContent = minutesToTime(startMin + idx*60);
      if(he) he.textContent = minutesToTime(startMin + (idx+1)*60);

      const c = (h.completed === "" ? null : Number(h.completed));
      const perMat = (c !== null && !Number.isNaN(c) && mats>0) ? (c/mats) : null;
      const hpm = document.getElementById(`hpm-${idx}`);
      if(hpm) hpm.textContent = perMat!==null ? fmt(perMat,2) : "-";
    });

    if(avgPerHour !== null && avgPerHour > 0){
      const estTotalHours = totalBouts / avgPerHour;
      el("estEndTime").textContent = minutesToTime(startMin + Math.round(estTotalHours*60));
    } else {
      el("estEndTime").textContent = "-";
    }

    recalcSim();
  }

  function recalcAll(){
    recalcPlanner();
    recalcLive();

    state.level = el("level").value;
    state.days = el("days").value;
    state.numWeights = Number(el("numWeights").value||13);
    state.day1Start = el("day1Start").value;
    state.day1End = el("day1End").value;
    state.day2Start = el("day2Start").value;
    state.pace = Number(el("pace").value||12);

    state.usePlannerTotal = el("usePlannerTotal").checked;
    state.totalBoutsOverride = Number(el("totalBouts").value||0);
    state.startTime = el("startTime").value;
    state.dashLevel = el("dashLevel").value;

    state.simMats = Number(el("simMats").value||0);
    state.simPace = Number(el("simPace").value||0);
    state.simStart = el("simStart").value;
    state.simTotalBoutsOverride = Number(el("simTotalBouts").value||0);
  }

  function bind(){
    ["level","format","days","numWeights","day1Start","day1End","day2Start","pace"].forEach(id=>{
      el(id).addEventListener("input", ()=>{
        if(id==="level"){ setPaceDefaults(true); }
        renderWeights();
        rebalanceAssignments();
        recalcAll();
        saveState();
      });
    });

    el("usePlannerTotal").addEventListener("change", ()=>{
      recalcAll(); saveState();
    });

    ["totalBouts","startTime","dashLevel"].forEach(id=>{
      el(id).addEventListener("input", ()=>{
        recalcLive(); saveState();
      });
    });

    ["simMats","simPace","simStart","simTotalBouts"].forEach(id=>{
      el(id).addEventListener("input", ()=>{
        recalcSim(); saveState();
      });
    });

    el("addHour").addEventListener("click", ()=>{
      state.hours.push({completed:""});
      renderHours();
      recalcLive();
      saveState();
    });

    el("clearHours").addEventListener("click", ()=>{
      if(!confirm("Clear all hourly completed inputs?")) return;
      state.hours = state.hours.map(()=>({completed:""}));
      renderHours();
      recalcLive();
      saveState();
    });

    el("addLoc").addEventListener("click", ()=>{
      state.locations.push({name:`Location ${state.locations.length+1}`, mats:0, remaining:0});
      renderLocations();
      rebalanceAssignments();
      recalcAll();
      saveState();
    });

    el("resetLoc").addEventListener("click", ()=>{
      if(!confirm("Reset locations to defaults?")) return;
      state.locations = JSON.parse(JSON.stringify(DEFAULTS.locations));
      renderLocations();
      rebalanceAssignments();
      recalcAll();
      saveState();
    });

    el("rebalance").addEventListener("click", ()=>{
      rebalanceAssignments();
      recalcAll();
      saveState();
    });

    el("resetAll").addEventListener("click", ()=>{
      if(!confirm("Reset everything? This will wipe saved values.")) return;
      localStorage.removeItem(LS_KEY);
      location.reload();
    });

    el("exportJson").addEventListener("click", ()=>{
      el("jsonBox").value = JSON.stringify(state, null, 2);
    });

    el("importJson").addEventListener("click", ()=>{
      try{
        const incoming = JSON.parse(el("jsonBox").value || "null");
        if(!incoming || typeof incoming !== "object") throw new Error("Invalid JSON");
        state = deepMerge(JSON.parse(JSON.stringify(DEFAULTS)), incoming);
        saveState();
        boot();
      }catch(e){
        alert("Could not import JSON. Make sure it is valid.");
      }
    });
  }

  function boot(){
    state = loadState();
    initControls();
    renderWeights();
    renderLocations();
    renderHours();
    rebalanceAssignments();
    recalcAll();
    saveState();
  }

  boot();
  bind();
</script>
</body>
</html>
