<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Matside — Control Panel v4.0</title>

<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
  :root {
    --bg: #0d0f11;
    --card: #16191d;
    --border: #22272e;
    --text: #ffffff;
    --muted: #8b949e;
    --accent: #2d8cf0;
    --red: #d84242;
    --green: #3ebd5d;
    --gold: #f1c40f;
    --radius: 14px;
    --gap: 14px;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto;
  }

  /* Header */
  .header {
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .header img {
    height: 44px;
    border-radius: 6px;
  }
  .header-title {
    font-size: 20px;
    font-weight: 700;
  }

  /* Layout */
  .wrap {
    padding: 18px;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Summary Bar */
  .summary {
    display: flex;
    justify-content: space-between;
    background: var(--card);
    padding: 14px;
    border-radius: var(--radius);
    font-size: 16px;
    margin-bottom: 18px;
    border: 1px solid var(--border);
  }

  /* Cards */
  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 16px;
    border: 1px solid var(--border);
  }
  .card h3 {
    margin: 0 0 12px 0;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--gap);
  }

  /* Timer Card */
  .timer-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--gap);
  }
  .timer-group {
    background: #1d2127;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid #2c323a;
    text-align: center;
  }
  .timer-group h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: var(--muted);
  }

  /* Buttons */
  button {
    padding: 10px 12px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 700;
    font-size: 14px;
    color: var(--text);
  }
  .btn-wide { width: 100%; }

  .red { background: var(--red); }
  .green { background: var(--green); }
  .blue { background: var(--accent); }
  .gray { background: #2b2f36; }
  .gold { background: var(--gold); color: #000; }

  .scoring-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }

  /* Timeline */
  #timelineBox {
    margin-top: 20px;
    padding: 14px;
    border-radius: var(--radius);
    background: var(--card);
    border: 1px solid var(--border);
    height: 220px;
    overflow-y: auto;
    font-size: 14px;
  }

  /* Modal */
  #matchModal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
  }
  .modal-inner {
    background: var(--card);
    padding: 20px;
    border-radius: var(--radius);
    width: 300px;
    text-align: center;
  }

  /* Toast */
  #toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent);
    padding: 12px 18px;
    border-radius: 10px;
    font-weight: 700;
    display: none;
  }

</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <img src="https://www.matside.org/assets/images/image01.png" />
  <div class="header-title">Matside — Control Panel</div>
</div>

<div class="wrap">

  <!-- SUMMARY -->
  <div class="summary">
    <div>Mat: <strong id="sumMat">1</strong></div>
    <div>Period: <strong id="sumPeriod">1</strong></div>
    <div>Time: <strong id="sumTime">01:00</strong></div>
    <div>Red: <strong id="sumRed">0</strong></div>
    <div>Green: <strong id="sumGreen">0</strong></div>

    <div>Status:
      <strong id="conn">connecting…</strong>
    </div>

    <select id="matSelect">
      <option value="1">Mat 1</option>
      <option value="2">Mat 2</option>
      <option value="3">Mat 3</option>
      <option value="4">Mat 4</option>
    </select>
  </div>

  <!-- MAIN GRID -->
  <div class="grid">

    <!-- TIMER CARD -->
    <div class="card">
      <h3>Timer</h3>

      <div class="timer-layout">

        <!-- Column 1 -->
        <div class="timer-group">
          <h4>Run Controls</h4>
          <button id="startBtn" class="blue btn-wide">Start</button><br><br>
          <button id="stopBtn" class="gray btn-wide">Stop</button><br><br>
          <button id="resetTimerBtn" class="gold btn-wide">Reset Timer</button>
        </div>

        <!-- Column 2 -->
        <div class="timer-group">
          <h4>Match Controls</h4>
          <button id="endMatchBtn" class="red btn-wide">End Match</button><br><br>
          <button id="nextPeriodBtn" class="blue btn-wide">Next Period</button><br><br>
          <button id="prevPeriodBtn" class="gray btn-wide">Prev Period</button>
        </div>

      </div>
    </div>

    <!-- SCORING CARD -->
    <div class="card">
      <h3>Scoring</h3>

      <div class="scoring-grid">
        <button class="red" data-color="red" data-pts="1">E1</button>
        <button class="red" data-color="red" data-pts="2">R2</button>
        <button class="red" data-color="red" data-pts="3">T3</button>
        <button class="red" data-color="red" data-pts="2">N2</button>
        <button class="red" data-color="red" data-pts="3">N3</button>
        <button class="red" data-color="red" data-pts="4">N4</button>

        <button class="green" data-color="green" data-pts="1">E1</button>
        <button class="green" data-color="green" data-pts="2">R2</button>
        <button class="green" data-color="green" data-pts="3">T3</button>
        <button class="green" data-color="green" data-pts="2">N2</button>
        <button class="green" data-color="green" data-pts="3">N3</button>
        <button class="green" data-color="green" data-pts="4">N4</button>
      </div>

      <br>
      <button id="subRed" class="gray">-1 Red</button>
      <button id="resetScores" class="gold">Reset</button>
      <button id="subGreen" class="gray">-1 Green</button>

    </div>

  </div>

  <!-- TIMELINE -->
  <h3 style="margin-top: 18px;">Match Timeline</h3>
  <div id="timelineBox"></div>

</div>

<!-- MATCH MODAL -->
<div id="matchModal">
  <div class="modal-inner">
    <h3>End Match</h3>
    <p>Select Winner:</p>

    <button id="redWin" class="red btn-wide">Red Wins</button><br><br>
    <button id="greenWin" class="green btn-wide">Green Wins</button><br><br>
    <button id="cancelEnd" class="gray btn-wide">Cancel</button>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// ======================================================
// SOCKET + STATE
// ======================================================
const socket = io("https://scoreboard-server-er33.onrender.com");
let mats = {};
let currentMat = 1;

socket.on("connect", () => {
  document.getElementById("conn").textContent = "connected";
});
socket.on("disconnect", () => {
  document.getElementById("conn").textContent = "disconnected";
});

socket.on("stateUpdate", payload => {
  if (!payload.mats) return;
  mats = payload.mats;
  renderSummary();
  renderTimeline();
});

// ======================================================
// UI UPDATE
// ======================================================
function renderSummary() {
  const m = mats[currentMat];
  if (!m) return;

  document.getElementById("sumMat").textContent = currentMat;
  document.getElementById("sumPeriod").textContent = m.segmentId || m.period;
  document.getElementById("sumTime").textContent = formatTime(m.time);
  document.getElementById("sumRed").textContent = m.red;
  document.getElementById("sumGreen").textContent = m.green;
}

function renderTimeline() {
  const box = document.getElementById("timelineBox");
  const m = mats[currentMat];
  if (!m || !m.timeline) return;

  box.innerHTML = m.timeline.map(t => `<div>${t}</div>`).join("");
}

function formatTime(sec) {
  const s = Math.max(0, Math.floor(sec));
  const m = Math.floor(s / 60);
  const r = s % 60;
  return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
}

// ======================================================
// MAT SELECTOR
// ======================================================
document.getElementById("matSelect").addEventListener("change", e => {
  currentMat = parseInt(e.target.value);
  renderSummary();
});

// ======================================================
// TIMER CONTROLS
// ======================================================
document.getElementById("startBtn").onclick = () => {
  socket.emit("updateState", { mat: currentMat, updates: { running: true } });
};
document.getElementById("stopBtn").onclick = () => {
  socket.emit("updateState", { mat: currentMat, updates: { running: false } });
};
document.getElementById("resetTimerBtn").onclick = () => {
  socket.emit("updateState", { mat: currentMat, updates: { time: 60, running: false } });
};

// ======================================================
// PERIOD CONTROLS
// ======================================================
document.getElementById("nextPeriodBtn").onclick = () => {
  socket.emit("updateState", { mat: currentMat, updates: { segmentId: "REG2", period: 2 }});
};
document.getElementById("prevPeriodBtn").onclick = () => {
  socket.emit("updateState", { mat: currentMat, updates: { segmentId: "REG1", period: 1 }});
};

// ======================================================
// SCORING
// ======================================================
document.querySelectorAll("[data-color][data-pts]").forEach(btn => {
  btn.onclick = () => {
    const color = btn.dataset.color;
    const pts = parseInt(btn.dataset.pts);
    socket.emit("addPoints", { mat: currentMat, color, pts });
  };
});
document.getElementById("subRed").onclick = () => {
  socket.emit("subPoint", { mat: currentMat, color: "red" });
};
document.getElementById("subGreen").onclick = () => {
  socket.emit("subPoint", { mat: currentMat, color: "green" });
};
document.getElementById("resetScores").onclick = () => {
  socket.emit("updateState", { mat: currentMat, updates: { red: 0, green: 0 }});
};

// ======================================================
// MATCH END MODAL
// ======================================================
const modal = document.getElementById("matchModal");

document.getElementById("endMatchBtn").onclick = () => modal.style.display = "flex";
document.getElementById("cancelEnd").onclick = () => modal.style.display = "none";

document.getElementById("redWin").onclick = () => submitMatch("red");
document.getElementById("greenWin").onclick = () => submitMatch("green");

function submitMatch(winner) {
  modal.style.display = "none";
  socket.emit("matchEnded", {
    mat: currentMat,
    winner,
    ts: Date.now()
  });
  showToast(`Match submitted — ${winner.toUpperCase()} wins`);
}

// ======================================================
// TOAST SYSTEM
// ======================================================
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(() => t.style.display = "none", 3000);
}

</script>

</body>
</html>
