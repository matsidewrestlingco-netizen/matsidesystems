<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Control â€“ Match Upload & Assignment</title>

  <!-- PapaParse CSV Parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
    }

    h2, h3 {
      margin-top: 0;
    }

    .section {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: 30px auto;
    }

    .pill-btn-fat {
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 25px;
      border: none;
      cursor: pointer;
      background: #0077ff;
      color: white;
      transition: 0.2s;
    }

    .pill-btn-fat:disabled {
      background: #9bbcf0;
      cursor: not-allowed;
    }

    .csv-preview {
      margin-top: 20px;
      max-height: 350px;
      overflow-y: auto;
    }

    .csv-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }

    .csv-table th,
    .csv-table td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      vertical-align: top;
    }

    .csv-table th {
      background: #e7e7e7;
      font-weight: bold;
    }
  </style>

</head>
<body>

  <!-- SECTION 1: CSV UPLOAD -->
  <div class="section">
    <h2>Upload Matches (CSV)</h2>
    <p>Select a CSV file containing match data.</p>

    <input type="file" id="matchCsvInput" accept=".csv" />
    <br><br>
    <button id="parseCsvBtn" class="pill-btn-fat" disabled>Parse CSV</button>

    <div id="csvPreview" class="csv-preview"></div>
  </div>

  <!-- SECTION 2: MATCH ASSIGNMENT -->
  <div class="section">
    <h2>Assign Matches to Mats</h2>

    <button id="loadMatchesBtn" class="pill-btn-fat">Load Matches from Cloud</button>

    <div id="assignmentTable" class="csv-preview"></div>
  </div>

  <script>
    /////////////////////////////////////////////////////////////////////////////
    // ðŸ”¥ FIREBASE INITIALIZATION
    /////////////////////////////////////////////////////////////////////////////
    const firebaseConfig = {
      apiKey: "AIzaSyD_uk47fURmQiHZnN8avfcGoNObMntdu_s",
      authDomain: "matsidewrestlingco-fb85f.firebaseapp.com",
      projectId: "matsidewrestlingco-fb85f",
      storageBucket: "matsidewrestlingco-fb85f.firebasestorage.app",
      messagingSenderId: "898197416726",
      appId: "1:898197416726:web:921ccbd0f63f7fd6537e37"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /////////////////////////////////////////////////////////////////////////////
    // STEP 1 â€” CSV UPLOAD + PARSE
    /////////////////////////////////////////////////////////////////////////////
    let uploadedCsvFile = null;
    let parsedMatches = [];

    document.getElementById("matchCsvInput").addEventListener("change", (e) => {
      uploadedCsvFile = e.target.files[0];
      document.getElementById("parseCsvBtn").disabled = !uploadedCsvFile;
    });

    document.getElementById("parseCsvBtn").addEventListener("click", () => {
      if (!uploadedCsvFile) return;

      Papa.parse(uploadedCsvFile, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          parsedMatches = results.data.map(row => {
            return {
              id: crypto.randomUUID(),
              bout: row.bout || row.Bout || "",
              weight: row.weight || row.Weight || "",
              round: row.round || row.Round || "",
              preferredMat: Number(row.mat || row.Mat || 0),

              red: {
                name: row.redName || row.RedName || row.Red || "",
                team: row.redTeam || row.RedTeam || ""
              },
              green: {
                name: row.greenName || row.GreenName || row.Green || "",
                team: row.greenTeam || row.GreenTeam || ""
              },

              assignedMat: null,
              status: "upcoming"
            };
          });

          showCsvPreview(parsedMatches);
        }
      });
    });

    /////////////////////////////////////////////////////////////////////////////
    // CSV PREVIEW TABLE
    /////////////////////////////////////////////////////////////////////////////
    function showCsvPreview(matches) {
      const container = document.getElementById("csvPreview");

      if (!matches.length) {
        container.innerHTML = "<p>No matches parsed.</p>";
        return;
      }

      let html = `
        <h3>Preview (${matches.length} matches)</h3>
        <table class="csv-table">
          <tr>
            <th>Bout</th>
            <th>Weight</th>
            <th>Red Wrestler</th>
            <th>Green Wrestler</th>
            <th>Round</th>
            <th>Mat Pref</th>
          </tr>
      `;

      matches.slice(0, 30).forEach(m => {
        html += `
          <tr>
            <td>${m.bout}</td>
            <td>${m.weight}</td>
            <td>${m.red.name} (${m.red.team})</td>
            <td>${m.green.name} (${m.green.team})</td>
            <td>${m.round}</td>
            <td>${m.preferredMat || "-"}</td>
          </tr>
        `;
      });

      html += "</table><br>";

      html += `
        <button id="saveToCloudBtn" class="pill-btn-fat">Save Matches to Cloud</button>
      `;

      container.innerHTML = html;

      document.getElementById("saveToCloudBtn")
        .addEventListener("click", saveMatchesToCloud);
    }

    /////////////////////////////////////////////////////////////////////////////
    // SAVE MATCHES TO FIRESTORE
    /////////////////////////////////////////////////////////////////////////////
    function saveMatchesToCloud() {
      if (!parsedMatches.length) {
        alert("No matches to save.");
        return;
      }

      const batch = db.batch();
      const matchCollection = db.collection("matchLibrary");

      parsedMatches.forEach(match => {
        const docRef = matchCollection.doc(match.id);
        batch.set(docRef, match);
      });

      batch.commit()
        .then(() => alert("Matches successfully saved to Firebase!"))
        .catch(err => {
          console.error(err);
          alert("Error saving matches.");
        });
    }

    /////////////////////////////////////////////////////////////////////////////
    // STEP 3 â€” LOAD MATCHES FOR ASSIGNMENT
    /////////////////////////////////////////////////////////////////////////////
    document.getElementById("loadMatchesBtn").addEventListener("click", loadMatchesFromCloud);

    function loadMatchesFromCloud() {
      db.collection("matchLibrary")
        .orderBy("bout")
        .get()
        .then(snapshot => {
          const matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          showAssignmentTable(matches);
        });
    }

    /////////////////////////////////////////////////////////////////////////////
    // MATCH ASSIGNMENT TABLE
    /////////////////////////////////////////////////////////////////////////////
    function showAssignmentTable(matches) {
      const container = document.getElementById("assignmentTable");

      if (!matches.length) {
        container.innerHTML = "<p>No matches found in cloud.</p>";
        return;
      }

      let html = `
        <h3>Assign Mats</h3>
        <table class="csv-table">
          <tr>
            <th>Bout</th>
            <th>Wrestlers</th>
            <th>Weight</th>
            <th>Assigned Mat</th>
            <th>Change Mat</th>
          </tr>
      `;

      matches.forEach(m => {
        html += `
          <tr>
            <td>${m.bout}</td>
            <td>
              ${m.red.name} (${m.red.team})
              <br>vs<br>
              ${m.green.name} (${m.green.team})
            </td>
            <td>${m.weight}</td>
            <td>${m.assignedMat ? "Mat " + m.assignedMat : "-"}</td>
            <td>
              <select data-id="${m.id}" class="matSelect">
                <option value="">--</option>
                <option value="1" ${m.assignedMat == 1 ? "selected" : ""}>Mat 1</option>
                <option value="2" ${m.assignedMat == 2 ? "selected" : ""}>Mat 2</option>
                <option value="3" ${m.assignedMat == 3 ? "selected" : ""}>Mat 3</option>
              </select>
            </td>
          </tr>
        `;
      });

      html += "</table>";

      container.innerHTML = html;

      // Attach listeners
      document.querySelectorAll(".matSelect").forEach(select => {
        select.addEventListener("change", updateMatchAssignment);
      });
    }

    /////////////////////////////////////////////////////////////////////////////
    // UPDATE FIRESTORE WITH NEW MAT ASSIGNMENT
    /////////////////////////////////////////////////////////////////////////////
    function updateMatchAssignment(e) {
      const matchId = e.target.getAttribute("data-id");
      const matValue = e.target.value === "" ? null : Number(e.target.value);

      db.collection("matchLibrary")
        .doc(matchId)
        .update({ assignedMat: matValue })
        .then(() => console.log("Updated mat:", matchId, "â†’", matValue))
        .catch(err => console.error(err));
    }

  </script>

</body>
</html>
