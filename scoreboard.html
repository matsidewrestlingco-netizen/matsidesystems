
<!-- ===========================
     public/scoreboard.html v2.7
     =========================== -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Matside — Scoreboard v2.7</title>

<script src="https://scoreboard-server-er33.onrender.com/socket.io/socket.io.js"></script>

<style>
  :root{
    --red:#d32f2f; --green:#00c853; --panel:#111216;
    --bg:#000; --muted:#888; --gold:#fbc02d;
  }
  html,body{
    margin:0;padding:0;background:#000;color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    text-align:center;
  }
  #scoreboard{
    max-width:760px;margin:0 auto;padding:6px;
  }
  table{
    width:100%;border-collapse:collapse;table-layout:fixed;
  }
  td{padding:4px;}
  .label{
    background:var(--panel);
    font-size:14px;font-weight:700;text-transform:uppercase;
  }
  .mat-num,.period-num{
    font-size:30px;font-weight:800;
  }
  .timer{
    font-size:60px;font-weight:900;padding:6px 0;
  }
  @keyframes timerPulse{
    0%{opacity:1;} 50%{opacity:.4;} 100%{opacity:1;}
  }
  .timer-running{animation:timerPulse 1.1s infinite ease-in-out;}
  .timer-zero{color:var(--gold);}
  .name{
    font-size:20px;font-weight:700;opacity:.9;
  }
  .name-red{color:var(--red);}
  .name-green{color:var(--green);}
  .score-box{
    font-size:64px;
    font-weight:700;
    padding:40px 0;
    border-radius:16px;
  }
  .score-red{background:var(--red);color:#fff;}
  .score-green{background:var(--green);color:#000;}
  .winner-tag{
    display:inline-block;margin-left:6px;padding:2px 6px;
    border-radius:999px;background:var(--gold);
    color:#000;font-size:12px;font-weight:700;
  }
  .branding{
    font-size:12px;color:var(--muted);padding-top:6px;
  }
</style>
</head>
<body>

<div id="scoreboard">
  <table>
    <tbody>
      <tr>
        <td class="label">MAT</td>
        <td class="label" colspan="2">MATSIDE SCOREBOARD</td>
        <td class="label">PERIOD</td>
      </tr>
      <tr>
        <td><div id="matNumber" class="mat-num">1</div></td>
        <td></td><td></td>
        <td><div id="periodNumber" class="period-num">1</div></td>
      </tr>
      <tr><td colspan="4" class="label">TIME</td></tr>
      <tr>
        <td colspan="4"><div id="timer" class="timer">00:00</div></td>
      </tr>
      <tr>
        <td id="redName" class="name name-red" colspan="2">RED WRESTLER</td>
        <td id="greenName" class="name name-green" colspan="2">GREEN WRESTLER</td>
      </tr>
      <tr>
        <td class="score-box score-red" colspan="2">
          <span id="scoreRed">0</span>
        </td>
        <td class="score-box score-green" colspan="2">
          <span id="scoreGreen">0</span>
        </td>
      </tr>
      <tr>
        <td colspan="4"><div class="branding">Matside — Live Mat View</div></td>
      </tr>
    </tbody>
  </table>
</div>

<script>
function getMatID(){
  const params = new URLSearchParams(window.location.search);
  const id = parseInt(params.get("mat"),10);
  return (id>=1 && id<=4)?id:1;
}
const MAT_ID = getMatID();
document.getElementById("matNumber").textContent = MAT_ID;

const socket = io("https://scoreboard-server-er33.onrender.com", {
  transports:["websocket","polling"]
});

const timerEl = document.getElementById("timer");
const periodEl = document.getElementById("periodNumber");
const scoreRedEl = document.getElementById("scoreRed");
const scoreGreenEl = document.getElementById("scoreGreen");
const redNameEl = document.getElementById("redName");
const greenNameEl = document.getElementById("greenName");

function formatTime(sec){
  sec = Math.max(0, sec || 0);
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}

socket.on("stateUpdate",(state)=>{
  const m = state.mats?.[MAT_ID];
  if(!m) return;
  updateTime(m);
  updateScores(m);
  updateNames(m);
});

function updateTime(m){
  timerEl.textContent = formatTime(m.time);
  if(m.running) timerEl.classList.add("timer-running");
  else timerEl.classList.remove("timer-running");
  if(m.time<=0) timerEl.classList.add("timer-zero");
  else timerEl.classList.remove("timer-zero");
  periodEl.textContent = m.period;
}

function isWinnerState(m){
  const red = m.red ?? 0;
  const green = m.green ?? 0;
  const diff = Math.abs(red - green);
  const period = m.period;
  const time = m.time ?? 0;
  const running = m.running;

  if(diff >= 15) return red !== green;

  if(typeof period === "number"){
    if(period === 3 && time === 0 && !running && red !== green) return true;
    return false;
  }

  const otPeriods = ["OT","TB1","TB2","UTB"];
  if(otPeriods.includes(String(period)) && time === 0 && !running && red !== green){
    return true;
  }
  return false;
}

function updateScores(m){
  const red = m.red ?? 0;
  const green = m.green ?? 0;
  scoreRedEl.textContent = red;
  scoreGreenEl.textContent = green;

  removeWinnerTags();
  if(isWinnerState(m)){
    if(red > green) attachWinner(redNameEl);
    else attachWinner(greenNameEl);
  }
}

function removeWinnerTags(){
  document.querySelectorAll(".winner-tag").forEach(el=>el.remove());
}
function attachWinner(nameEl){
  const tag = document.createElement("span");
  tag.className = "winner-tag";
  tag.textContent = "WINNER";
  nameEl.appendChild(tag);
}

function updateNames(m){
  // TODO: event-based names; for now local control / defaults
  try{
    const raw = localStorage.getItem("matsideNames");
    if(raw){
      const names = JSON.parse(raw);
      const n = names[MAT_ID] || {};
      if(n.red) redNameEl.textContent = n.red;
      else redNameEl.textContent = "RED WRESTLER";
      if(n.green) greenNameEl.textContent = n.green;
      else greenNameEl.textContent = "GREEN WRESTLER";
      return;
    }
  }catch(e){}
  redNameEl.textContent = "RED WRESTLER";
  greenNameEl.textContent = "GREEN WRESTLER";
}
</script>

</body>
</html>
